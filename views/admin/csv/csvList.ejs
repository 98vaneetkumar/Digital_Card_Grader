<!-- BEGIN: Head-->
<%- include('../../common/header') %>
<!-- END: Head-->

<!-- BEGIN: Body-->
<body
  class="vertical-layout vertical-menu-modern navbar-floating footer-static"
  data-open="click"
  data-menu="vertical-menu-modern"
  data-col=""
>
  <!-- sidebar -->
  <%- include('../../common/sidebar') %>
  <!-- navbar -->
  <%- include('../../common/navbar') %>

  <!-- BEGIN: Content-->
  <div class="app-content content">
    <div class="content-overlay"></div>
    <div class="header-navbar-shadow"></div>
    <div class="content-wrapper container-xxl p-0">
      <div class="content-body">
        <!-- CSV List Section Start -->
        <div class="row" id="csv-list">
          <div class="col-12">
            <div class="card card-body">
              <!-- Add CSV Button -->
              <div class="d-flex justify-content-end mb-3">
                <div style="max-width: 200px">
                  <a
                    href="/admin/csvUpload"
                    class="btn"
                    style="
                      background: linear-gradient(to right, #2a2a2a, #555);
                      color: white;
                      border: none;
                      padding: 10px 20px;
                      border-radius: 5px;
                    "
                  >
                    <i class="fa fa-plus"></i> Add CSV
                  </a>
                </div>
              </div>

              <!-- CSV Table -->
              <div class="table-responsive">
                <table id="csvTable" class="table table-md">
                  <thead>
                    <tr style="background-color: #f8f9fa">
                      <th scope="col">S No.</th>
                      <th scope="col">File Name</th>
                      <th scope="col">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% csvFiles.forEach(function(file, i) { %>
                    <tr id="csv-row-<%= file.id %>">
                      <td><%= 1 + i %></td>
                      <td><%= file.name %></td>
                     <td>
                      <button
                        onclick="viewCsv('<%= file.id %>')"
                        class="btn btn-outline-primary btn-sm"
                      >
                        <i class="fas fa-eye"></i>
                      </button>


                        <button
                          onclick="deleteCsv('<%= file.id %>')"
                          class="btn btn-outline-danger btn-sm"
                        >
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>

                    </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- CSV List Section End -->
      </div>
    </div>
  </div>
  <!-- END: Content-->

  <!-- BEGIN: Footer-->
  <%- include('../../common/footer') %>
  <!-- END: Footer-->

  <%- include('../../common/script') %>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js"></script>

  <script>
  function viewCsv(id) {
    $.ajax({
      url: "/admin/viewCsv",
      method: "POST",
      data: { id: id },
      success: function(res) {
        if(res.success) {
          // Open in a new tab using Blob
          const blob = new Blob([res.data], { type: "text/plain" });
          const url = window.URL.createObjectURL(blob);
          const newTab = window.open(url, "_blank");
          newTab.document.title = res.name;
        } else {
          Swal.fire("Error ❌", res.message || "Could not open CSV", "error");
        }
      },
      error: function() {
        Swal.fire("Error ❌", "Server error", "error");
      }
    });
  }
</script>

  <script>
    $(document).ready(function () {
      $("#csvTable").DataTable();
    });

    function deleteCsv(id) {
      Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, delete it!",
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: "/admin/deleteCsv",
            method: "post",
            data: { id: id },
            success: function (res) {
              if (res.success) {
                Swal.fire({
                  title: "Deleted!",
                  text: "CSV file has been deleted successfully.",
                  icon: "success",
                  timer: 2000,
                  showConfirmButton: false,
                });

                setTimeout(() => {
                  $(`#csv-row-${id}`).remove();
                  $("#csvTable tbody tr").each(function (index) {
                    $(this).find("td:first").text(index + 1);
                  });
                }, 2000);
              }
            },
            error: function (err) {
              Swal.fire({
                title: "Error!",
                text: "There was an issue deleting the CSV.",
                icon: "error",
              });
            },
          });
        }
      });
    }
  </script>
</body>
<!-- END: Body-->
